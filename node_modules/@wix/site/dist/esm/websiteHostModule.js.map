{"version":3,"names":["withResolvers","createWebsiteModule","_ref","createHost","__type","create","_host","host","options","_window$commonConfig","_window$commonConfig2","applicationId","wixEmbedsAPI","window","undefined","apiBaseUrl","getApiBaseUrl","getMonitoringClient","getMonitoringClientFunction","essentials","language","commonConfig","locale","auth","getAccessTokenFn","getAccessTokenFunction","injectorCreated","resolve","resolveAccessTokenFn","promise","accessTokenFnPromise","getAuthHeaders","Error","headers","Authorization","getAccessTokenInjector","_getAccessTokenFn","getExternalBaseUrl","parsedUrlObject","URL","pathname","hostname"],"sources":["../../src/websiteHostModule.ts"],"sourcesContent":["import type { HostModule } from '@wix/sdk-types';\nimport { withResolvers } from './utils';\nimport {\n  AccessTokenFn,\n  CreateAuthStrategy,\n  CreateWebsiteHost,\n  Host,\n  SDK,\n  SDKOptions,\n  WixEmbedsAPI,\n} from './types';\n\ndeclare global {\n  interface Window {\n    wixEmbedsAPI?: WixEmbedsAPI;\n    commonConfig?: {\n      language?: string;\n      locale?: string;\n    };\n  }\n}\n\nexport const createWebsiteModule = ({\n  createHost,\n}: {\n  createHost: CreateWebsiteHost;\n}): HostModule<SDK, Host> & {\n  host: CreateWebsiteHost;\n  auth: CreateAuthStrategy;\n} => {\n  return {\n    __type: 'host',\n    create: (_host) => {\n      // Here we can implement module methods that could be used by the SDK via \"wixClient.use(website)\" api.\n      // We don't have any for now, so we just return an empty object.\n      return {};\n    },\n    host: (options?: SDKOptions) => {\n      const { applicationId } = options ?? {};\n      const wixEmbedsAPI =\n        typeof window !== 'undefined' ? window.wixEmbedsAPI : undefined;\n\n      const host = createHost(options);\n      const apiBaseUrl = getApiBaseUrl();\n\n      return {\n        ...host,\n        apiBaseUrl,\n        getMonitoringClient:\n          wixEmbedsAPI?.getMonitoringClientFunction?.(applicationId),\n        essentials: {\n          language:\n            typeof window !== 'undefined'\n              ? window.commonConfig?.language\n              : undefined,\n          locale:\n            typeof window !== 'undefined'\n              ? window.commonConfig?.locale\n              : undefined,\n        },\n      };\n    },\n    auth: (getAccessTokenFn?: AccessTokenFn) => {\n      const wixEmbedsAPI =\n        typeof window !== 'undefined' ? window.wixEmbedsAPI : undefined;\n\n      if (!getAccessTokenFn) {\n        /*\n        We must call wixEmbedsAPI.getAccessTokenFunction() in the main frame and not from async callbacks / setTimeout calls\n        since it uses document.currentScript API behind the scenes\n        https://developer.mozilla.org/en-US/docs/Web/API/Document/currentScript\n        * */\n        getAccessTokenFn = wixEmbedsAPI?.getAccessTokenFunction?.();\n      }\n\n      let injectorCreated = false;\n\n      const { resolve: resolveAccessTokenFn, promise: accessTokenFnPromise } =\n        withResolvers<AccessTokenFn>();\n\n      return {\n        getAuthHeaders: async () => {\n          if (!getAccessTokenFn && injectorCreated) {\n            getAccessTokenFn = await accessTokenFnPromise;\n          }\n\n          if (!getAccessTokenFn) {\n            throw new Error('Failed to resolve auth token');\n          }\n\n          return {\n            headers: {\n              Authorization: await getAccessTokenFn(),\n            },\n          };\n        },\n        getAccessTokenInjector: () => {\n          injectorCreated = true;\n\n          return (_getAccessTokenFn: AccessTokenFn) => {\n            resolveAccessTokenFn(_getAccessTokenFn);\n          };\n        },\n      };\n    },\n  };\n};\n\nfunction getApiBaseUrl() {\n  const wixEmbedsAPI =\n    typeof window !== 'undefined' ? window.wixEmbedsAPI : undefined;\n  const apiBaseUrl = wixEmbedsAPI?.getExternalBaseUrl?.();\n  if (!apiBaseUrl) {\n    return;\n  }\n\n  // clean the protocol from the URL\n  const parsedUrlObject = new URL(apiBaseUrl);\n  if (parsedUrlObject?.pathname && parsedUrlObject.pathname !== '/') {\n    return `${parsedUrlObject.hostname}${parsedUrlObject.pathname}`;\n  }\n\n  return parsedUrlObject.hostname;\n}\n"],"mappings":"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"}